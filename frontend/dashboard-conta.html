<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Minha conta ‚Ä¢ Liberdade Financeira</title>
  <link rel="stylesheet" href="/assets/app.css"/>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="card sidecard">
        <div class="brand"><span class="dot"></span> Liberdade Financeira</div>
        <div class="muted small" id="who" style="margin-top:8px;">Carregando‚Ä¶</div>
      </div>

      <div class="nav">
        <a href="/dashboard.html">Vis√£o geral <span class="muted small">‚Üí</span></a>
        <a href="/dashboard-conteudo.html">Conte√∫do <span class="muted small">‚Üí</span></a>
        <a href="/dashboard-afiliado.html">Afiliado <span class="muted small">‚Üí</span></a>
        <a class="active" href="/dashboard-conta.html">Minha conta <span class="muted small">‚Üí</span></a>
        <a href="/index.html">Sair (p√∫blico) <span class="muted small">‚Üí</span></a>
      </div>

      <div style="height:12px"></div>
      <button id="logout" class="btn ghost" style="width:100%;">Encerrar sess√£o</button>
    </aside>

    <main class="main">
      <div class="card section">
        <h2 style="margin:0 0 6px;">Minha conta</h2>
        <p class="muted" style="margin:0;">Dados e status da assinatura.</p>
      </div>

      <div style="height:14px"></div>

      <div class="grid" style="grid-template-columns: 1fr 1fr;">
        <div class="card section">
          <div class="badge">üë§ Dados</div>
          <div id="data" class="muted" style="margin-top:10px;">Carregando‚Ä¶</div>
        </div>
        <div class="card section">
          <div class="badge">üßæ Assinatura</div>
          <div id="sub" class="muted" style="margin-top:10px;">Carregando‚Ä¶</div>
          <p class="muted small" style="margin-top:10px;">
            Renova√ß√£o autom√°tica ser√° controlada quando o pagamento estiver integrado (via gateway).
          </p>
        </div>
      </div>

      <div style="height:14px"></div>

      <div class="card section">
        <div class="badge">Seguran√ßa</div>
        <p class="muted small" style="margin-top:10px;">
          Sua sess√£o √© protegida por token (JWT). Para sua seguran√ßa, encerre a sess√£o ao usar computador compartilhado.
        </p>
      </div>

      <div id="toast" class="toast"><div class="msg"></div></div>
    </main>
  </div>

  <script type="module">
    import { clearToken, me, requireLogged, requireActive } from "/assets/auth.js";
    import { toast } from "/assets/ui.js";

    requireLogged();

    document.getElementById("logout").addEventListener("click", () => {
      clearToken();
      location.href = "/login.html";
    });

    async function init(){
      try{
        const data = await me();
        const user = data.user;
        document.getElementById("who").textContent = `${user.name} ‚Ä¢ ${user.email}`;
        if (!requireActive(user.subscription)) return;

        document.getElementById("data").innerHTML = `
          <div class="muted small">Nome</div>
          <div><b>${user.name}</b></div>
          <div style="height:10px"></div>
          <div class="muted small">E-mail</div>
          <div><b>${user.email}</b></div>
          <div style="height:10px"></div>
          <div class="muted small">Seu c√≥digo afiliado</div>
          <div><b>${user.affiliateCode}</b></div>
        `;

        const end = user.subscription.currentPeriodEnd
          ? new Date(user.subscription.currentPeriodEnd).toLocaleString("pt-BR")
          : "-";

        document.getElementById("sub").innerHTML = `
          <div class="badge">Status: <b>${user.subscription.status}</b></div>
          <div class="muted small" style="margin-top:8px;">
            Plano: <b>${user.subscription.plan}</b><br/>
            Renova√ß√£o autom√°tica: <b>${user.subscription.renovacaoAutomatica ? "SIM" : "N√ÉO"}</b><br/>
            Vencimento: <b>${end}</b>
          </div>
        `;
      }catch(e){
        toast("Falha ao carregar conta.", "error");
        clearToken();
        setTimeout(()=> location.href="/login.html", 900);
      }
    }

    init();
  </script>
</body>
</html>
