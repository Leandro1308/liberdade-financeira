<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Afiliado ‚Ä¢ Liberdade Financeira</title>
  <link rel="stylesheet" href="/assets/app.css"/>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="card sidecard">
        <div class="brand"><span class="dot"></span> Liberdade Financeira</div>
        <div class="muted small" id="who" style="margin-top:8px;">Carregando‚Ä¶</div>
      </div>

      <div class="nav">
        <a href="/dashboard.html">Vis√£o geral <span class="muted small">‚Üí</span></a>
        <a href="/dashboard-conteudo.html">Conte√∫do <span class="muted small">‚Üí</span></a>
        <a class="active" href="/dashboard-afiliado.html">Afiliado <span class="muted small">‚Üí</span></a>
        <a href="/dashboard-conta.html">Minha conta <span class="muted small">‚Üí</span></a>
        <a href="/index.html">Sair (p√∫blico) <span class="muted small">‚Üí</span></a>
      </div>

      <div style="height:12px"></div>
      <button id="logout" class="btn ghost" style="width:100%;">Encerrar sess√£o</button>
    </aside>

    <main class="main">
      <div class="card section">
        <h2 style="margin:0 0 6px;">√Årea de afiliado</h2>
        <p class="muted" style="margin:0;">Seu link pessoal e estat√≠sticas (pagamento entra depois).</p>
      </div>

      <div style="height:14px"></div>

      <div class="grid" style="grid-template-columns: 1fr 1fr;">
        <div class="card section">
          <div class="badge">üîó Seu link</div>
          <input id="link" class="input" style="margin-top:10px;" readonly/>
          <button id="copy" class="btn" style="margin-top:10px;">Copiar link</button>
          <p class="muted small" style="margin-top:10px;">
            Quem criar conta por esse link vira seu indicado (ref).
          </p>
        </div>

        <div class="card section">
          <div class="badge">üìä Estat√≠sticas</div>
          <div id="stats" class="muted" style="margin-top:10px;">Carregando‚Ä¶</div>
        </div>
      </div>

      <div id="toast" class="toast"><div class="msg"></div></div>
    </main>
  </div>

  <script type="module">
    import { clearToken, me, requireLogged, requireActive, getToken } from "/assets/auth.js";
    import { api } from "/assets/api.js";
    import { toast } from "/assets/ui.js";

    requireLogged();

    document.getElementById("logout").addEventListener("click", () => {
      clearToken();
      location.href = "/login.html";
    });

    document.getElementById("copy").addEventListener("click", async () => {
      const input = document.getElementById("link");
      try{
        await navigator.clipboard.writeText(input.value);
        toast("Link copiado!");
      }catch{
        input.select();
        document.execCommand("copy");
        toast("Link copiado!");
      }
    });

    async function init(){
      try{
        const data = await me();
        const user = data.user;
        document.getElementById("who").textContent = `${user.name} ‚Ä¢ ${user.email}`;
        if (!requireActive(user.subscription)) return;

        const token = getToken();
        const summary = await api("/api/affiliate/summary", { token });

        const fullLink = `${location.origin}${summary.link}`;
        document.getElementById("link").value = fullLink;

        document.getElementById("stats").innerHTML = `
          <div class="badge">Seu c√≥digo: <b>${summary.affiliateCode}</b></div>
          <div class="muted small" style="margin-top:8px;">
            Total de indicados: <b>${summary.totalIndicados}</b>
          </div>
        `;
      }catch(e){
        toast("Falha ao carregar afiliado.", "error");
        clearToken();
        setTimeout(()=> location.href="/login.html", 900);
      }
    }

    init();
  </script>
</body>
</html>
