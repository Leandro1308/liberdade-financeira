<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Assinatura ‚Ä¢ Liberdade Financeira</title>
  <link rel="stylesheet" href="/assets/app.css"/>
</head>
<body>
  <div class="container">
    <div class="card topbar">
      <div class="brand"><span class="dot"></span> Liberdade Financeira</div>
      <div style="display:flex; gap:10px;">
        <a class="badge" href="/index.html">In√≠cio</a>
        <a class="badge" href="/login.html">Entrar</a>
        <a class="badge" href="/dashboard.html">Dashboard</a>
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="card section" style="max-width:900px; margin:0 auto;">
      <h1 style="margin:0 0 8px; font-size:34px; line-height:1.15;">Ativar assinatura</h1>
      <p class="muted" style="margin:0 0 14px; font-size:18px; line-height:1.6;">
        Para liberar o acesso ao dashboard, voc√™ vai usar <b>uma √∫nica carteira</b>:
        ela ser√° usada para <b>pagar a assinatura</b> e tamb√©m para <b>receber suas comiss√µes</b>.
      </p>

      <!-- ‚úÖ MOBILE: abrir dentro do MetaMask -->
      <div id="mobileBox" class="card" style="padding:16px; border-radius:16px; display:none;">
        <div class="badge" style="margin-bottom:10px;">No celular</div>
        <p class="muted" style="margin:0 0 10px; font-size:16.5px; line-height:1.6;">
          Para assinar pelo celular, abra esta p√°gina dentro do navegador do <b>MetaMask</b>.
        </p>
        <button id="btnOpenMM" class="btn primary" style="width:100%; font-size:16.5px; padding:14px;">
          Abrir no MetaMask
        </button>
        <p class="muted small" style="margin-top:10px; font-size:14.5px;">
          Se aparecer um aviso do MetaMask (‚Äúprossiga com cautela‚Äù), toque em <b>Continuar</b>.
        </p>
      </div>

      <div style="height:14px"></div>

      <div id="planInfo" class="badge" style="font-size:15px; padding:10px 12px;">Carregando par√¢metros‚Ä¶</div>
      <div id="netInfo" class="muted" style="margin-top:10px; font-size:15.5px;"></div>

      <div style="height:14px"></div>

      <!-- ‚úÖ ORIENTA√á√ïES SIMPLIFICADAS (do jeito que voc√™ pediu) -->
      <div class="card" style="padding:16px; border-radius:16px;">
        <div class="badge" style="margin-bottom:10px;">O que voc√™ precisa ter na sua carteira</div>

        <div style="font-size:18px; line-height:1.7;">
          <ol style="margin:0; padding-left:20px;">
            <li>
              Instale o <b>MetaMask</b> e crie sua carteira.
            </li>
            <li style="margin-top:10px;">
              Fa√ßa um dep√≥sito inicial simples:
              <ul style="margin:8px 0 0; padding-left:18px;">
                <li><b>15 USDT</b> (Tether USD)</li>
                <li>Depois, troque <b>3 USDT</b> por <b>BNB</b> (Binance Coin) dentro do MetaMask (Troca)</li>
              </ul>
              <div class="muted" style="margin-top:10px;">
                Ser√° cobrada uma pequena taxa de rede em <b>BNB</b> na primeira autoriza√ß√£o (normalmente inferior a <b>US$1</b>).
              </div>
            </li>
          </ol>

          <div style="height:10px"></div>

          <p class="muted small" style="margin:0; font-size:14.5px;">
            Obs.: o sistema funciona na rede <b>BNB Smart Chain</b>. Se voc√™ estiver na rede errada (Ethereum),
            n√≥s vamos pedir a troca automaticamente.
          </p>
        </div>
      </div>

      <div style="height:14px"></div>

      <!-- ‚úÖ CARTEIRA -->
      <div class="card" style="padding:16px; border-radius:16px;">
        <div class="badge">Carteira principal</div>
        <p class="muted" style="margin:10px 0 0; font-size:16.5px;">
          Cole abaixo o endere√ßo da sua carteira (0x...). Se preferir, voc√™ pode conectar o MetaMask para preencher automaticamente.
        </p>

        <div style="height:10px"></div>

        <input id="walletInput" class="input" placeholder="Cole aqui o endere√ßo (0x...)"
               style="font-size:16px; padding:14px; border-radius:14px;"/>

        <div style="height:10px"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="btnConnect" class="btn">Conectar MetaMask (opcional)</button>
          <button id="btnSaveWallet" class="btn">Salvar carteira</button>
          <button id="btnCheckBalances" class="btn ghost">Verificar saldos</button>
        </div>

        <div id="walletBox" class="muted" style="margin-top:10px; font-size:15.5px;"></div>
        <div id="balancesBox" class="muted" style="margin-top:8px; font-size:15.5px;"></div>
      </div>

      <div style="height:14px"></div>

      <!-- ‚úÖ A√á√ÉO √öNICA -->
      <div class="card" style="padding:16px; border-radius:16px;">
        <div class="badge">Ativar acesso</div>

        <div style="height:10px"></div>

        <button id="btnSubscribe" class="btn primary" style="width:100%; font-size:16.5px; padding:14px;">
          Ativar assinatura
        </button>
        <p class="muted" style="margin-top:10px; font-size:15.5px; line-height:1.55;">
          Se for sua primeira vez, o MetaMask pode pedir uma confirma√ß√£o extra para autorizar o d√©bito do USDT.
          Depois, a assinatura √© ativada e o acesso ao dashboard √© liberado.
        </p>

        <div style="height:12px"></div>
        <div class="badge">Status da sua conta</div>
        <div id="status" class="muted" style="margin-top:8px;">Carregando‚Ä¶</div>

        <div style="height:12px"></div>
        <a class="btn" style="width:100%;" href="/dashboard.html">Ir para dashboard</a>
      </div>

      <div id="toast" class="toast"><div class="msg"></div></div>
    </div>
  </div>

  <script type="module">
    import { me, requireLogged, saveWallet, getToken } from "/assets/auth.js";
    import { api } from "/assets/api.js";
    import { toast } from "/assets/ui.js";

    requireLogged();

    const statusEl = document.getElementById("status");
    const planInfo = document.getElementById("planInfo");
    const netInfo = document.getElementById("netInfo");
    const walletBox = document.getElementById("walletBox");
    const balancesBox = document.getElementById("balancesBox");
    const walletInput = document.getElementById("walletInput");

    const btnSubscribe = document.getElementById("btnSubscribe");
    const btnConnect = document.getElementById("btnConnect");
    const btnSaveWallet = document.getElementById("btnSaveWallet");
    const btnCheckBalances = document.getElementById("btnCheckBalances");

    const mobileBox = document.getElementById("mobileBox");
    const btnOpenMM = document.getElementById("btnOpenMM");

    let params = null;

    // ---- helpers
    function is0xAddress(v){
      return /^0x[a-fA-F0-9]{40}$/.test(String(v||"").trim());
    }
    function shortAddr(a){
      if (!a) return "";
      return `${a.slice(0,6)}‚Ä¶${a.slice(-4)}`;
    }
    function isMobile(){
      return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    }
    function isInMetaMask(){
      // MetaMask Mobile injecta window.ethereum e costuma ter isMetaMask = true,
      // mas em alguns navegadores m√≥veis pode existir outro provider.
      return !!(window.ethereum && window.ethereum.isMetaMask);
    }
    function openInMetaMask(){
      const url = `${location.protocol}//${location.host}${location.pathname}${location.search}${location.hash}`;
      // deep link padr√£o da MetaMask
      const deep = `https://metamask.app.link/dapp/${encodeURIComponent(location.host + location.pathname + location.search)}`;
      // tenta abrir
      location.href = deep;
      // fallback: se n√£o abrir, o usu√°rio j√° est√° vendo a p√°gina com instru√ß√£o
    }

    // ---- BNB Smart Chain (Mainnet)
    const BSC_CHAIN_ID_HEX = "0x38"; // 56
    const BSC_PARAMS = {
      chainId: BSC_CHAIN_ID_HEX,
      chainName: "BNB Smart Chain",
      nativeCurrency: { name: "BNB", symbol: "BNB", decimals: 18 },
      rpcUrls: ["https://rpc.ankr.com/bsc"], // sem key (ok pra agora)
      blockExplorerUrls: ["https://bscscan.com"],
    };

    async function ensureBscChain(){
      if (!window.ethereum) {
        netInfo.textContent = "MetaMask n√£o encontrado.";
        return false;
      }
      try{
        const chainId = await window.ethereum.request({ method:"eth_chainId" });
        if (chainId === BSC_CHAIN_ID_HEX) {
          netInfo.innerHTML = `Rede: <b>BNB Smart Chain</b>`;
          return true;
        }

        netInfo.innerHTML = `Rede atual: <b>${chainId}</b> ‚Äî trocando para <b>BNB Smart Chain</b>...`;

        try{
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: BSC_CHAIN_ID_HEX }],
          });
          netInfo.innerHTML = `Rede: <b>BNB Smart Chain</b>`;
          return true;
        }catch(switchErr){
          // se a rede n√£o existir no metamask (4902), adiciona
          if (switchErr?.code === 4902) {
            await window.ethereum.request({
              method: "wallet_addEthereumChain",
              params: [BSC_PARAMS],
            });
            // tenta switch de novo
            await window.ethereum.request({
              method: "wallet_switchEthereumChain",
              params: [{ chainId: BSC_CHAIN_ID_HEX }],
            });
            netInfo.innerHTML = `Rede: <b>BNB Smart Chain</b>`;
            return true;
          }
          netInfo.innerHTML = `Rede errada. Troque para <b>BNB Smart Chain</b> no MetaMask.`;
          return false;
        }
      }catch(e){
        console.error(e);
        netInfo.textContent = "N√£o foi poss√≠vel verificar a rede agora.";
        return false;
      }
    }

    async function loadStatus(){
      try{
        const data = await me();
        const sub = data?.user?.subscription;

        statusEl.innerHTML = `
          <div class="badge">Status: <b>${sub?.status || "inactive"}</b></div>
          <div class="muted small" style="margin-top:8px; font-size:14.5px;">
            Renova√ß√£o autom√°tica: <b>${sub?.renovacaoAutomatica ? "SIM" : "N√ÉO"}</b><br/>
            Vencimento: <b>${sub?.currentPeriodEnd ? new Date(sub.currentPeriodEnd).toLocaleString("pt-BR") : "-"}</b>
          </div>
        `;
      }catch{
        statusEl.textContent = "Falha ao carregar status.";
      }
    }

    async function loadParams(){
      try{
        params = await api("/api/assinatura/params");
        const feePct = ((params.txFeeBps || 0) / 100).toFixed(2);
        planInfo.textContent = `Taxa administrativa: ${feePct}% | Contrato: ${shortAddr(params.contractAddress)}`;
      }catch(e){
        console.error(e);
        params = null;
        planInfo.textContent = "Par√¢metros indispon√≠veis (tente novamente).";
      }
    }

    async function connectWallet(){
      if (!window.ethereum) return toast("MetaMask n√£o encontrado.", "error");
      try{
        // tenta garantir BSC j√° no connect (evita ficar em Ethereum)
        await ensureBscChain();

        const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
        const acc = accounts?.[0] || null;
        if (!acc) return toast("Nenhuma carteira selecionada.", "error");
        walletInput.value = acc;
        toast("Carteira preenchida.");
      }catch(e){
        console.error(e);
        toast("Falha ao conectar MetaMask.", "error");
      }
    }

    async function saveWalletManual(){
      const w = walletInput.value.trim();
      if (!is0xAddress(w)) return toast("Cole um endere√ßo v√°lido (0x...).", "error");
      await saveWallet(w);
      walletBox.innerHTML = `Carteira salva: <b>${w}</b>`;
      toast("Carteira vinculada.");
    }

    async function checkBalances(){
      if (!window.ethereum) return toast("MetaMask n√£o encontrado.", "error");
      if (!params?.token) return toast("Par√¢metros indispon√≠veis.", "error");

      // for√ßa rede correta antes de ler saldo
      const okNet = await ensureBscChain();
      if (!okNet) return toast("Troque para BNB Smart Chain no MetaMask.", "error");

      const w = walletInput.value.trim();
      if (!is0xAddress(w)) return toast("Cole um endere√ßo v√°lido (0x...).", "error");

      try{
        const { ethers } = await import("https://cdn.jsdelivr.net/npm/ethers@6.13.4/+esm");
        const provider = new ethers.BrowserProvider(window.ethereum);

        const bnb = await provider.getBalance(w);

        const erc20Abi = ["function balanceOf(address) view returns (uint256)", "function decimals() view returns (uint8)"];
        const usdt = new ethers.Contract(params.token, erc20Abi, provider);
        const [raw, dec] = await Promise.all([usdt.balanceOf(w), usdt.decimals()]);
        const usdtFmt = ethers.formatUnits(raw, dec);

        balancesBox.innerHTML = `
          <div class="badge">Saldos</div>
          <div class="muted" style="margin-top:8px;">
            ‚Ä¢ BNB: <b>${ethers.formatEther(bnb)}</b><br/>
            ‚Ä¢ USDT: <b>${usdtFmt}</b>
          </div>
        `;
      }catch(e){
        console.error(e);
        toast("N√£o foi poss√≠vel verificar saldos agora.", "error");
      }
    }

    async function subscribe(){
      if (!window.ethereum) {
        toast("MetaMask n√£o encontrado.", "error");
        return;
      }
      if (!params) {
        toast("Par√¢metros indispon√≠veis.", "error");
        return;
      }

      // üîí garante rede BSC antes de tudo
      const okNet = await ensureBscChain();
      if (!okNet) return toast("Troque para BNB Smart Chain no MetaMask.", "error");

      const w = walletInput.value.trim();
      if (!is0xAddress(w)) return toast("Cole e salve a carteira primeiro.", "error");

      try{
        btnSubscribe.disabled = true;
        btnSubscribe.style.opacity = "0.7";
        btnSubscribe.textContent = "Processando‚Ä¶";

        await api("/api/assinatura/subscribe", {
          method:"POST",
          token: getToken(),
          body: { walletAddress: w, referrerCode: null }
        });

        toast("Assinatura ativada!");
        await loadStatus();
      }catch(e){
        console.error(e);
        const msg = e?.message || "Falha ao assinar";
        if (msg === "APPROVE_REQUIRED") {
          toast("Falta a autoriza√ß√£o do USDT. O MetaMask vai solicitar automaticamente na pr√≥xima tentativa.", "error");
        } else {
          toast(msg, "error");
        }
      }finally{
        btnSubscribe.disabled = false;
        btnSubscribe.style.opacity = "1";
        btnSubscribe.textContent = "Ativar assinatura";
      }
    }

    // ---- UI: mobile guidance
    function setupMobileBox(){
      if (!isMobile()) return;

      // Se estiver no celular e n√£o estiver no MetaMask, mostra o bloco
      if (!isInMetaMask()){
        mobileBox.style.display = "block";
      } else {
        mobileBox.style.display = "none";
      }

      btnOpenMM.addEventListener("click", () => openInMetaMask());
    }

    // ---- events
    btnConnect.addEventListener("click", connectWallet);
    btnSaveWallet.addEventListener("click", saveWalletManual);
    btnCheckBalances.addEventListener("click", checkBalances);
    btnSubscribe.addEventListener("click", subscribe);

    // Se o usu√°rio trocar rede/conta, atualiza aviso
    if (window.ethereum?.on){
      window.ethereum.on("chainChanged", () => ensureBscChain());
      window.ethereum.on("accountsChanged", (accs) => {
        if (accs?.[0]) walletInput.value = accs[0];
      });
    }

    setupMobileBox();
    await loadParams();
    await loadStatus();

    // tenta ajustar rede no carregamento (se j√° estiver no MetaMask)
    if (window.ethereum) {
      await ensureBscChain();
    }
  </script>
</body>
</html>
