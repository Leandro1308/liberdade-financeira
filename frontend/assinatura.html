<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ativar assinatura</title>
  <link rel="stylesheet" href="/assets/app.css" />
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="topbar">
        <div class="brand">
          <span class="dot"></span>
          <div>
            <div style="font-size:18px; line-height:1; font-weight:900;">Liberdade Financeira</div>
            <div class="muted small">Ativar assinatura</div>
          </div>
        </div>
        <div class="badge" id="netBadge">Rede: <b style="margin-left:6px">-</b></div>
      </div>

      <div class="section grid" style="gap:18px;">
        <div>
          <h1 style="margin:0 0 6px;font-size:34px;letter-spacing:-0.02em;">Ativar assinatura</h1>
          <p class="muted" style="margin:0;">
            Para liberar o acesso ao dashboard, você vai usar <b>uma única carteira</b>:
            ela será usada para <b>pagar a assinatura</b> e também para <b>receber suas comissões</b>.
          </p>
        </div>

        <!-- Mobile: abrir no MetaMask -->
        <div class="card" style="padding:16px;">
          <div class="badge" style="margin-bottom:10px;">No celular</div>
          <div class="muted" style="margin-bottom:10px;">
            Para assinar pelo celular, o ideal é abrir esta página dentro do navegador do MetaMask.
          </div>
          <button class="btn primary" id="btnOpenMM">Abrir no MetaMask</button>
          <div class="small muted" style="margin-top:10px;">
            Se aparecer um aviso “prossiga com cautela”, é normal: você está abrindo um dApp externo.
          </div>
        </div>

        <!-- Passos simples -->
        <div class="card" style="padding:16px;">
          <div class="badge" style="margin-bottom:10px;">Antes de continuar</div>

          <div class="grid" style="gap:10px;">
            <div class="muted">
              <b>Você precisa ter na sua carteira:</b><br/>
              • <b>Binance Coin (BNB)</b><br/>
              • <b>Tether USD (USDT)</b>
            </div>

            <div class="muted">
              ✅ Forma mais simples de preparar (recomendado):<br/>
              1) Deposite <b>15 USDT</b> na sua carteira<br/>
              2) Troque <b>3 USDT</b> por <b>BNB</b> (para taxas de rede)<br/>
              3) Deixe o restante em <b>USDT</b> para a assinatura
            </div>

            <div class="small muted">
              <b>Taxa de rede:</b> na primeira autorização, será cobrada uma taxa pequena em <b>BNB</b>
              (normalmente inferior a <b>US$ 1</b>).
            </div>
          </div>
        </div>

        <!-- Carteira -->
        <div class="card" style="padding:16px;">
          <div class="badge" style="margin-bottom:10px;">Carteira principal</div>

          <div class="muted" style="margin-bottom:10px;">
            Cole abaixo o endereço da sua carteira (0x...). Se preferir, você pode conectar o MetaMask
            para preencher automaticamente.
          </div>

          <input class="input" id="walletInput" placeholder="Cole aqui o endereço (0x...)" />

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
            <button class="btn" id="btnConnect">Conectar MetaMask (opcional)</button>
            <button class="btn" id="btnSave">Salvar carteira</button>
            <button class="btn ghost" id="btnCheck">Verificar saldos</button>
          </div>

          <div class="muted small" id="savedInfo" style="margin-top:10px;display:none;"></div>

          <div class="muted" id="balancesBox" style="margin-top:10px;display:none;">
            <div class="badge" style="margin-bottom:8px;">Saldos</div>
            <div>• BNB: <b id="balBNB">0.0</b></div>
            <div>• USDT: <b id="balUSDT">0.0</b></div>
          </div>
        </div>

        <!-- Assinar -->
        <div class="card" style="padding:16px;">
          <div class="badge" style="margin-bottom:10px;">Ativar acesso</div>

          <button class="btn primary" id="btnSubscribe" style="width:100%;font-size:18px;">
            Ativar assinatura
          </button>

          <div class="small muted" style="margin-top:10px;">
            Se for a sua primeira vez, o MetaMask pode pedir uma confirmação extra para autorizar
            o débito do USDT. Depois, a assinatura é ativada e o acesso ao dashboard é liberado.
          </div>

          <div id="statusBox" class="muted" style="margin-top:12px;">
            <div class="badge" style="margin-bottom:8px;">Status da sua conta</div>
            <div>Status: <b id="accStatus">-</b></div>
            <div>Renovação automática: <b id="accAuto">-</b></div>
            <div>Vencimento: <b id="accDue">-</b></div>
          </div>

          <div style="margin-top:14px;">
            <a class="btn ghost" href="/dashboard.html" style="display:inline-block;">Ir para dashboard</a>
          </div>
        </div>

      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <script src="/assets/api.js"></script>
  <script src="/assets/ui.js"></script>

  <script>
    // ===============================
    // Helpers UI (fallback caso ui.js não tenha)
    // ===============================
    function toast(msg, type){
      const el = document.getElementById('toast');
      if (!el) return;
      el.className = 'toast show' + (type === 'error' ? ' error' : '');
      el.textContent = msg;
      setTimeout(()=>{ el.className='toast'; }, 4500);
    }

    function isMobile(){
      return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    // Deep link para abrir no navegador interno do MetaMask (melhor no iOS)
    function getMetaMaskDappLink(){
      const url = location.href;
      // metamask.app.link/dapp/<host>/<path...>
      const clean = url.replace(/^https?:\/\//, '');
      return 'https://metamask.app.link/dapp/' + clean;
    }

    // ===============================
    // BNB Chain auto-switch
    // ===============================
    const BSC_CHAIN_ID = '0x38'; // 56
    const BSC_PARAMS = {
      chainId: BSC_CHAIN_ID,
      chainName: 'BNB Chain',
      nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
      rpcUrls: ['https://bsc-dataseed.binance.org/'],
      blockExplorerUrls: ['https://bscscan.com']
    };

    async function ensureBsc(){
      if (!window.ethereum) throw new Error('MetaMask não detectado.');

      try{
        // já atualiza badge se possível
        const current = await ethereum.request({ method:'eth_chainId' });
        if (current === BSC_CHAIN_ID) return true;

        await ethereum.request({
          method:'wallet_switchEthereumChain',
          params:[{ chainId: BSC_CHAIN_ID }]
        });

        return true;
      }catch(err){
        // 4902 = rede não adicionada
        if (err && err.code === 4902){
          await ethereum.request({
            method:'wallet_addEthereumChain',
            params:[BSC_PARAMS]
          });
          return true;
        }
        throw err;
      }
    }

    async function refreshNetBadge(){
      const badge = document.getElementById('netBadge');
      if (!badge) return;
      try{
        if (!window.ethereum){
          badge.innerHTML = 'Rede: <b style="margin-left:6px">-</b>';
          return;
        }
        const chainId = await ethereum.request({ method:'eth_chainId' });
        const label = (chainId === BSC_CHAIN_ID) ? 'BNB Chain' : ('Chain ' + chainId);
        badge.innerHTML = 'Rede: <b style="margin-left:6px">' + label + '</b>';
      }catch(e){
        badge.innerHTML = 'Rede: <b style="margin-left:6px">-</b>';
      }
    }

    // ===============================
    // Integração com seu backend existente
    // (não quebra: usa endpoints que já aparecem nos logs)
    // ===============================
    async function apiGetMe(){
      const r = await fetch('/api/me', { credentials:'include' });
      if (!r.ok) throw new Error('Não autenticado.');
      return r.json();
    }

    async function apiSaveWallet(wallet){
      const r = await fetch('/api/me/wallet', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify({ wallet })
      });
      if (!r.ok){
        const t = await r.text().catch(()=> '');
        throw new Error(t || 'Falha ao salvar carteira.');
      }
      return r.json().catch(()=> ({}));
    }

    async function apiParams(){
      const r = await fetch('/api/assinatura/params', { credentials:'include' });
      if (!r.ok) throw new Error('Falha ao carregar parâmetros.');
      return r.json();
    }

    async function apiSubscribe(){
      const r = await fetch('/api/assinatura/subscribe', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify({})
      });
      const data = await r.json().catch(()=> ({}));
      if (!r.ok){
        throw new Error(data?.error || 'Falha ao iniciar assinatura.');
      }
      return data;
    }

    // Envia tx no formato { from, to, data, value } (hex strings)
    async function sendTx(tx){
      return ethereum.request({ method:'eth_sendTransaction', params:[tx] });
    }

    function isValidAddress(v){
      return /^0x[a-fA-F0-9]{40}$/.test((v||'').trim());
    }

    function setStatusUI(me){
      const st = document.getElementById('accStatus');
      const au = document.getElementById('accAuto');
      const du = document.getElementById('accDue');
      if (!st || !au || !du) return;

      // Ajuste conforme seu backend retorna
      st.textContent = me?.assinatura?.status || me?.status || 'inactive';
      au.textContent = (me?.assinatura?.autoRenew ?? me?.autoRenew) ? 'SIM' : 'NÃO';
      du.textContent = me?.assinatura?.vencimento || me?.dueDate || '-';
    }

    // ===============================
    // Eventos
    // ===============================
    (async function init(){
      document.getElementById('btnOpenMM').addEventListener('click', ()=>{
        location.href = getMetaMaskDappLink();
      });

      await refreshNetBadge();

      if (window.ethereum){
        ethereum.on?.('chainChanged', ()=>{ refreshNetBadge(); });
        ethereum.on?.('accountsChanged', ()=>{ /* opcional */ });
      }

      // carrega status
      try{
        const me = await apiGetMe();
        setStatusUI(me);
        if (me?.wallet && isValidAddress(me.wallet)){
          document.getElementById('walletInput').value = me.wallet;
          const info = document.getElementById('savedInfo');
          info.style.display = 'block';
          info.innerHTML = 'Carteira salva: <b>' + me.wallet + '</b>';
        }
      }catch(e){
        // ignora aqui (usuário pode estar antes do login)
      }
    })();

    // Conectar (opcional)
    document.getElementById('btnConnect').addEventListener('click', async ()=>{
      try{
        if (!window.ethereum){
          toast('MetaMask não detectado. No celular, use "Abrir no MetaMask".', 'error');
          return;
        }

        // ✅ força BNB Chain antes de conectar
        await ensureBsc();

        const accounts = await ethereum.request({ method:'eth_requestAccounts' });
        const acc = accounts?.[0];
        if (!acc) throw new Error('Nenhuma conta selecionada.');

        document.getElementById('walletInput').value = acc;
        toast('Carteira conectada: ' + acc.slice(0,6) + '...' + acc.slice(-4));
        await refreshNetBadge();
      }catch(err){
        toast(err?.message || 'Falha ao conectar MetaMask.', 'error');
      }
    });

    // Salvar carteira
    document.getElementById('btnSave').addEventListener('click', async ()=>{
      try{
        const wallet = document.getElementById('walletInput').value.trim();
        if (!isValidAddress(wallet)) throw new Error('Cole um endereço válido (começa com 0x...).');

        await apiSaveWallet(wallet);

        const info = document.getElementById('savedInfo');
        info.style.display = 'block';
        info.innerHTML = 'Carteira salva: <b>' + wallet + '</b>';

        toast('Carteira salva com sucesso.');
      }catch(err){
        toast(err?.message || 'Falha ao salvar carteira.', 'error');
      }
    });

    // Verificar saldos (mantém seu backend; se retornar 0 e o usuário tiver saldo em outra rede, é normal)
    document.getElementById('btnCheck').addEventListener('click', async ()=>{
      try{
        const p = await apiParams(); // você já tem esse endpoint nos logs
        // esperamos que params venha com saldos ou outro endpoint; se não vier, só informamos a rede
        await refreshNetBadge();

        // Se seu /api/assinatura/params já retorna balances, preenche aqui:
        const bnb = p?.balances?.bnb ?? p?.bnb ?? null;
        const usdt = p?.balances?.usdt ?? p?.usdt ?? null;

        if (bnb != null || usdt != null){
          document.getElementById('balancesBox').style.display = 'block';
          if (bnb != null) document.getElementById('balBNB').textContent = bnb;
          if (usdt != null) document.getElementById('balUSDT').textContent = usdt;
        } else {
          toast('Saldos: verificação disponível após conectar na BNB Chain.', 'error');
        }
      }catch(err){
        toast(err?.message || 'Falha ao verificar saldos.', 'error');
      }
    });

    // Ativar assinatura
    document.getElementById('btnSubscribe').addEventListener('click', async ()=>{
      try{
        if (!window.ethereum){
          toast('MetaMask não detectado. No celular, use "Abrir no MetaMask".', 'error');
          return;
        }

        // ✅ GARANTIA: sempre em BNB Chain antes de iniciar a assinatura
        await ensureBsc();
        await refreshNetBadge();

        // backend inicia e pode retornar transações necessárias (approve + cobrança)
        const flow = await apiSubscribe();

        // ✅ Tentativa 1: backend retorna txs em sequência
        if (Array.isArray(flow?.txs) && flow.txs.length){
          const accounts = await ethereum.request({ method:'eth_requestAccounts' });
          const from = accounts?.[0];
          if (!from) throw new Error('Selecione uma conta no MetaMask.');

          for (const raw of flow.txs){
            const tx = Object.assign({}, raw);
            tx.from = tx.from || from;
            tx.value = tx.value || '0x0';
            await sendTx(tx);
          }

          toast('Transações enviadas. Aguarde a confirmação no MetaMask.');
        } else {
          // ✅ fallback: se backend não retorna txs, apenas orienta
          toast('Confirme a autorização no MetaMask (BNB Chain) e tente novamente.');
        }

        // Recarrega status
        const me = await apiGetMe();
        setStatusUI(me);

      }catch(err){
        // Mensagem mais humana para o caso mais comum:
        const m = (err?.message || '').toLowerCase();
        if (m.includes('user rejected') || m.includes('rejeit') || m.includes('denied')){
          toast('Você cancelou no MetaMask. Tente novamente e confirme as telas.', 'error');
        } else if (m.includes('ethereum') && m.includes('chain')){
          toast('Troque para BNB Chain no MetaMask e tente novamente.', 'error');
        } else {
          toast(err?.message || 'Não foi possível ativar a assinatura.', 'error');
        }
      }
    });
  </script>
</body>
</html>
