<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Assinatura • Liberdade Financeira</title>
  <link rel="stylesheet" href="/assets/app.css"/>
  <style>
    .centered {
      max-width: 850px;
      margin: 0 auto;
    }
    .info-box {
      margin-top: 20px;
      padding: 20px;
      border-radius: 16px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.08);
      font-size: 16px;
      line-height: 1.6;
    }
    .mono {
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container centered">

    <div class="card topbar">
      <div class="brand"><span class="dot"></span> Liberdade Financeira</div>
      <div style="display:flex; gap:10px;">
        <a class="badge" href="/index.html">Início</a>
        <a class="badge" href="/login.html">Entrar</a>
        <a class="badge" href="/dashboard.html">Dashboard</a>
      </div>
    </div>

    <div style="height:20px"></div>

    <div class="card section">

      <h2>Plano Mensal</h2>
      <p class="muted">
        Acesso completo ao conteúdo + dashboard + área de afiliado.
      </p>

      <div id="planInfo" class="badge">Carregando parâmetros...</div>

      <!-- ORIENTAÇÃO COMPLETA -->
      <div class="info-box">

        <h3>Antes de continuar, prepare sua carteira</h3>

        <div style="margin-top:12px;">
          <b>1) Instale e crie sua carteira MetaMask</b><br/>
          Baixe o aplicativo MetaMask no seu celular ou instale a extensão no navegador.<br/>
          Crie sua carteira e <b>guarde sua frase de segurança em local seguro</b>.
        </div>

        <div style="margin-top:16px;">
          <b>2) Coloque saldo na sua carteira</b><br/>
          Você precisa ter, <b>na mesma carteira</b>:
          <ul style="margin-top:8px;">
            <li>
              <b>Binance Coin (BNB)</b> → para pagar a taxa administrativa de autorização  
              (recomendado: <b>0,005 BNB</b> | mínimo: <b>0,002 BNB</b>)
            </li>
            <li>
              <b>Tether USD (USDT - BEP-20)</b> → para pagar a assinatura
            </li>
          </ul>
        </div>

        <div style="margin-top:16px;">
          <b>3) Como enviar corretamente os valores</b><br/>
          • Copie o endereço da sua carteira (começa com <span class="mono">0x...</span>)<br/>
          • Envie <b>Binance Coin (BNB)</b> para esse endereço<br/>
          • Envie <b>Tether USD (USDT)</b> usando a rede <b>BNB Smart Chain (BEP-20)</b><br/><br/>

          ⚠️ Se enviar por outra rede (ERC20 ou TRC20), o valor não funcionará aqui.
        </div>

        <div style="margin-top:16px;">
          <b>USDT não aparece na MetaMask?</b><br/>
          Na MetaMask:
          <ol style="margin-top:6px;">
            <li>Toque em <b>Importar Token</b></li>
            <li>Pesquise por <b>Tether USD</b></li>
            <li>Se não aparecer, adicione manualmente usando este contrato oficial:</li>
          </ol>

          <div style="margin-top:8px; padding:10px; background: rgba(0,0,0,.35); border-radius:10px;" class="mono">
            0x55d398326f99059fF775485246999027B3197955
          </div>
        </div>

        <div style="margin-top:16px;">
          <b>Importante:</b> essa carteira será usada para 
          <b>pagar a assinatura</b> e também para 
          <b>receber suas comissões</b>.
        </div>

      </div>

      <div style="height:20px"></div>

      <label style="font-size:16px;">
        Carteira principal (onde será debitado o USDT e onde você receberá comissões)
      </label>

      <input id="walletInput" type="text" placeholder="Cole aqui o endereço da sua carteira (0x...)" />

      <div style="height:14px"></div>

      <button id="btnConnect" class="btn">Conectar MetaMask</button>

      <div style="height:10px"></div>

      <button id="btnApprove" class="btn">
        1) Autorizar pagamento (uma única vez)
      </button>

      <p class="muted small" style="margin-top:10px;">
        Esta etapa permite que a assinatura seja debitada em USDT.
        Você verá uma pequena taxa administrativa para concluir essa autorização.
      </p>

      <div style="height:10px"></div>

      <button id="btnSubscribe" class="btn primary">
        2) Confirmar assinatura
      </button>

      <p class="muted small" style="margin-top:10px;">
        Após confirmar, sua assinatura será ativada e o acesso ao dashboard será liberado.
      </p>

      <div id="walletBox" class="muted small" style="margin-top:14px;"></div>

      <div style="height:30px"></div>

      <h3>Status da sua conta</h3>
      <div id="status" class="muted">Carregando...</div>

      <div style="height:14px"></div>

      <a class="btn" href="/dashboard.html">Ir para dashboard</a>

    </div>

  </div>

  <script type="module">
    import { me, requireLogged, saveWallet } from "/assets/auth.js";
    import { api } from "/assets/api.js";
    import { toast } from "/assets/ui.js";

    const token = requireLogged();
    const statusEl = document.getElementById("status");
    const planInfo = document.getElementById("planInfo");
    const walletBox = document.getElementById("walletBox");
    const walletInput = document.getElementById("walletInput");

    let params = null;
    let connectedWallet = null;

    async function loadStatus(){
      try{
        const data = await me();
        const sub = data?.user?.subscription;
        statusEl.innerHTML = `
          <div class="badge">Status: <b>${sub?.status || "inactive"}</b></div>
          <div class="muted small" style="margin-top:8px;">
            Renovação automática: <b>${sub?.renovacaoAutomatica ? "SIM" : "NÃO"}</b><br/>
            Vencimento: <b>${sub?.currentPeriodEnd ? new Date(sub.currentPeriodEnd).toLocaleString("pt-BR") : "-"}</b>
          </div>
        `;
      }catch(e){
        statusEl.textContent = "Falha ao carregar status.";
      }
    }

    async function loadParams(){
      try{
        params = await api("/api/assinatura/params");
        const feePct = ((params.txFeeBps || 0) / 100).toFixed(2);
        planInfo.textContent = `Contrato ativo | Taxa administrativa: ${feePct}%`;
      }catch(e){
        planInfo.textContent = "Parâmetros temporariamente indisponíveis.";
      }
    }

    async function connectWallet(){
      if (!window.ethereum) {
        toast("MetaMask não encontrado.", "error");
        return;
      }
      try{
        const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
        connectedWallet = accounts?.[0] || null;

        if (!connectedWallet) {
          toast("Nenhuma carteira selecionada.", "error");
          return;
        }

        walletInput.value = connectedWallet;
        walletBox.innerHTML = `Carteira conectada: <b>${connectedWallet}</b>`;

        await saveWallet(connectedWallet);
        toast("Carteira vinculada com sucesso.");
      }catch(e){
        toast("Falha ao conectar carteira.", "error");
      }
    }

    async function approveUSDT(){
      if (!window.ethereum) return toast("MetaMask não encontrado.", "error");
      if (!params) return toast("Carregando parâmetros...", "error");

      const walletAddress = walletInput.value.trim();
      if (!walletAddress) return toast("Informe sua carteira primeiro.", "error");

      try{
        const { ethers } = await import("https://cdn.jsdelivr.net/npm/ethers@6.13.4/+esm");
        const provider = new ethers.BrowserProvider(window.ethereum);
        const signer = await provider.getSigner();

        const usdtAbi = ["function approve(address spender, uint256 value) returns (bool)"];
        const usdt = new ethers.Contract(params.token, usdtAbi, signer);

        const price = BigInt(params.price);
        const feeBps = BigInt(params.txFeeBps || 0);
        const total = (price * (BigInt(10000) + feeBps)) / BigInt(10000);

        toast("Confirme a autorização na MetaMask...");
        const tx = await usdt.approve(params.contractAddress, total);
        await tx.wait();

        toast("Autorização concluída com sucesso!");
      } catch (e) {
        toast("Falha na autorização.", "error");
      }
    }

    async function subscribe(){
      const walletAddress = walletInput.value.trim();
      if (!walletAddress) return toast("Informe sua carteira primeiro.", "error");

      try{
        await api("/api/assinatura/subscribe", {
          method:"POST",
          token,
          body:{
            walletAddress: walletAddress,
            referrerCode: null
          }
        });

        toast("Assinatura ativada com sucesso!");
        await loadStatus();
      }catch(e){
        const msg = e?.message || "Falha ao assinar";
        if (msg === "APPROVE_REQUIRED") {
          toast("Você precisa autorizar primeiro.", "error");
        } else {
          toast(msg, "error");
        }
      }
    }

    document.getElementById("btnConnect").addEventListener("click", connectWallet);
    document.getElementById("btnApprove").addEventListener("click", approveUSDT);
    document.getElementById("btnSubscribe").addEventListener("click", subscribe);

    await loadParams();
    await loadStatus();
  </script>

</body>
</html>
